#!/usr/bin/env bash

{{ template "script_caffeinate" . }}

set -e

if ! command -v nix &> /dev/null
then
  echo "[!] nix not found, installing"

  bash <(curl -L https://nixos.org/nix/install) --daemon --yes --no-modify-profile
fi

echo "[+] Launching nix-daemon"
. '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'

{{ if eq .chezmoi.os "darwin" }}
if ! command -v darwin-rebuild &> /dev/null
then
  echo "[!] darwin-rebuild not found, building nix-darwin"

  # nix-daemon takes some time to start up
  sleep 5

  cd $(mktemp -d)

  nix-build https://github.com/LnL7/nix-darwin/archive/master.tar.gz -A installer

  if [ -f /etc/nix/nix.conf ]; then
    echo "[+] Moving existing /etc/nix/nix.conf to /etc/nix/nix.conf.orig"
    sudo mv /etc/nix/nix.conf /etc/nix/nix.conf.orig
  fi

  echo "[+] Installing nix-darwin"
  ./result/bin/darwin-installer
fi
{{ else }}
echo "[!] Nix setup not implemented on this system ({{ .chezmoi.os }}) yet"
{{ end }}
